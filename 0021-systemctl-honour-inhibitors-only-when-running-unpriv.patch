From 05e814d1f8bc47dddcd737ee0a6e9f25e6c1a7c7 Mon Sep 17 00:00:00 2001
From: Lennart Poettering <lennart@poettering.net>
Date: Sat, 12 Jan 2013 00:09:22 +0100
Subject: [PATCH] systemctl: honour inhibitors only when running unprivileged
 (cherry picked from commit 748ebafa7a10d4e1f168dd8ae0193124cdf4226e)

---
 src/systemctl/systemctl.c | 29 +++++++++++++++++------------
 1 file changed, 17 insertions(+), 12 deletions(-)

diff --git a/src/systemctl/systemctl.c b/src/systemctl/systemctl.c
index b876720..012fd56 100644
--- a/src/systemctl/systemctl.c
+++ b/src/systemctl/systemctl.c
@@ -1815,7 +1815,16 @@ static int check_inhibitors(DBusConnection *bus, enum action a) {
         int r;
         unsigned c = 0;
 
-        if (arg_ignore_inhibitors)
+        if (!bus)
+                return 0;
+
+        if (arg_ignore_inhibitors || arg_force > 0)
+                return 0;
+
+        if (arg_when > 0)
+                return 0;
+
+        if (geteuid() == 0)
                 return 0;
 
         if (!on_tty())
@@ -1914,6 +1923,10 @@ static int start_special(DBusConnection *bus, char **args) {
 
         a = verb_to_action(args[0]);
 
+        r = check_inhibitors(bus, a);
+        if (r < 0)
+                return r;
+
         if (arg_force >= 2 && geteuid() != 0) {
                 log_error("Must be root.");
                 return -EPERM;
@@ -1933,12 +1946,6 @@ static int start_special(DBusConnection *bus, char **args) {
              a == ACTION_EXIT))
                 return daemon_reload(bus, args);
 
-        if (arg_force <= 0) {
-                r = check_inhibitors(bus, a);
-                if (r < 0)
-                        return r;
-        }
-
         /* first try logind, to allow authentication with polkit */
         if (geteuid() != 0 &&
             (a == ACTION_POWEROFF ||
@@ -5344,11 +5351,9 @@ static _noreturn_ void halt_now(enum action a) {
 static int halt_main(DBusConnection *bus) {
         int r;
 
-        if (arg_when <= 0 && arg_force <= 0) {
-                r = check_inhibitors(bus, arg_action);
-                if (r < 0)
-                        return r;
-        }
+        r = check_inhibitors(bus, arg_action);
+        if (r < 0)
+                return r;
 
         if (geteuid() != 0) {
                 /* Try logind if we are a normal user and no special
