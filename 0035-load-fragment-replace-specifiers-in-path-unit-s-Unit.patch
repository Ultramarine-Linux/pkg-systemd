From e01cec2c1a88aa7d110e41e7deb717bb71d04db0 Mon Sep 17 00:00:00 2001
From: Lennart Poettering <lennart@poettering.net>
Date: Tue, 15 Jan 2013 21:37:17 +0100
Subject: [PATCH] load-fragment: replace specifiers in path unit's Unit=
 setting (cherry picked from commit 858c33bf6002bcdbea185ddedde8f8d660afc731)

---
 src/core/load-fragment.c | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/src/core/load-fragment.c b/src/core/load-fragment.c
index e35fdbc..0869d4f 100644
--- a/src/core/load-fragment.c
+++ b/src/core/load-fragment.c
@@ -1287,6 +1287,7 @@ int config_parse_path_unit(
         int r;
         DBusError error;
         Unit *u;
+        _cleanup_free_ char *p = NULL;
 
         assert(filename);
         assert(lvalue);
@@ -1295,13 +1296,18 @@ int config_parse_path_unit(
 
         dbus_error_init(&error);
 
-        if (endswith(rvalue, ".path")) {
-                log_error("[%s:%u] Unit cannot be of type path, ignoring: %s", filename, line, rvalue);
+        p = unit_name_printf(u, rvalue);
+        if (!p)
+                return log_oom();
+
+        if (endswith(p, ".path")) {
+                log_error("[%s:%u] Unit cannot be of type path, ignoring: %s", filename, line, p);
                 return 0;
         }
 
-        if ((r = manager_load_unit(UNIT(t)->manager, rvalue, NULL, &error, &u)) < 0) {
-                log_error("[%s:%u] Failed to load unit %s, ignoring: %s", filename, line, rvalue, bus_error(&error, r));
+        r = manager_load_unit(UNIT(t)->manager, p, NULL, &error, &u);
+        if (r < 0) {
+                log_error("[%s:%u] Failed to load unit %s, ignoring: %s", filename, line, p, bus_error(&error, r));
                 dbus_error_free(&error);
                 return 0;
         }
